#
#  Author:liuyf
#  Email:liuyf90@gmail.com
#  Time:Nov 29, 2022 at 14:40
#
#  webvpn nginx config
#  @download_server :  proxy to actual url or domainname
#  /: busi logic that where to proxy
#  
#

log_format varups '$upstream_addr $upstream_connect_time $upstream_header_time $upstream_response_time '
                  '$upstream_response_length $upstream_bytes_received '
                  '$upstream_status $upstream_http_server $upstream_cache_status';


server {
        listen 8888;
        server_name proxyman.com;
        resolver 172.16.17.23;
        access_log logs/upstream_access.log varups;
        #set init variety
        location / {
            include mime.types;
            #set varible to proxy 
            set $proxy '';
            set $casport '';
            set_by_lua_block $casport {
                local data = require "lua.init_data"
                return data.get("casport");          -- return the $casport value normally
            } 
            #proxy_redirect     off;
            proxy_set_header   X-Real-IP        $remote_addr;
            proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
            proxy_set_header   Host             $host;
            rewrite (authserver/)(.*)$ $scheme://$Host:$casport/$1$2 last;
            #set_by_lua_file lua/req_init.lua;
            # busi logic that where to proxy
            access_by_lua_file lua/access.lua;
            # rewrite content body 
            body_filter_by_lua_file lua/replace.lua;
            header_filter_by_lua_block {
            }
        }
       # location @download_server {
       #     proxy_set_header Accept-Encoding "";
       #     proxy_set_header Host      $host;
       # #   proxy_pass $scheme://$proxy$request_uri;
       #     #proxy_pass http://oa.hrbfu.edu.cn;
       #     proxy_pass http://proxyman.com:9999;
       #     # set resp header in here
       #     header_filter_by_lua_file lua/resp_header_filter.lua;

       # }
        location @download_server {
            proxy_set_header Accept-Encoding "";
            proxy_pass $scheme://$proxy$request_uri;
            # set resp header in here
            header_filter_by_lua_file lua/resp_header_filter.lua;
        }
        
            
}

 
